<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-shared-lib/core-shared-lib.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<polymer-element name="bus-detail-line" attributes="lineId">
    <template>
        <style>
            google-map {
                height: 400px;
            }

            div.headers {
                width: calc(100%-40px);
                margin: 20px;
            }

            div.headers paper-dropdown-menu {
                margin:0;
            }

            div.headers paper-button {
                float: right;
            }
        </style>
        <div class="headers">
            <paper-dropdown-menu on-core-select="{{changeDirection}}" label="{{directions[currentDirection].destination}}">
                <paper-dropdown class="dropdown">
                    <core-menu class="menu">
                        <template repeat="{{direction, index in directions}}">
                            <paper-item data-direction={{index}}>{{direction.destination}}</paper-item>
                        </template>
                    </core-menu>
                </paper-dropdown>
            </paper-dropdown-menu>


            <paper-button on-click="{{closeLine}}" raised>Fermer la ligne</paper-button>
        </div>

        <google-map latitude="{{latitude}}" longitude="{{longitude}}" fitToMarkers>
            <template repeat="{{bus in directions[currentDirection].allBus}}">
                <google-map-marker latitude="{{bus.latitude}}" longitude="{{bus.longitude}}">
                    Destination : {{bus.destination}}
                </google-map-marker>
            </template>
        </google-map>

    </template>
    <script src="../bower_components/underscore/underscore-min.js"></script>
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>
    <script>
        Polymer('bus-detail-line', {
            latitude: 48.100,
            longitude: -1.667,
            apiKey: 'd366bf8684b3b3253a566602cfbc5017f0bebfb622042b19d45ecb2e',
            currentDirection: 0,
            directions: [
                {destination: "Toutes destinations"}
            ],
            url: function () {
                return 'https://data.explore.star.fr/api/records/1.0/search?apikey=' + this.apiKey + '&dataset=tco-bus-vehicules-position-tr&q=idligne:' + this.lineId + '&rows=9999'
            },
            loadData: function () {
                var self = this;
                $.ajax({
                    type: 'GET',
                    url: this.url(),
                    async: false,
                    dataType: 'jsonp',
                    success: function (json) {
                        var sumLatitude = 0;
                        var sumLongitude = 0;
                        var allBus = _.map(json.records, function (bus) {
                            sumLatitude += bus.fields.coordonnees[0];
                            sumLongitude += bus.fields.coordonnees[1];
                            return {
                                destination: bus.fields.destination,
                                latitude: bus.fields.coordonnees[0],
                                longitude: bus.fields.coordonnees[1]
                            }
                        });
                        self.latitude = sumLatitude / allBus.length;
                        self.longitude = sumLongitude / allBus.length;
                        self.directions = [{
                            destination: "Toutes destinations",
                            allBus: allBus
                        }];


                        self.directions = self.directions.concat(_.map(_.groupBy(allBus, function (bus) {
                            return bus.destination;
                        }), function (busOfDestination) {
                            return {
                                destination: busOfDestination[0].destination,
                                allBus: busOfDestination
                            }
                        }));

                        setTimeout(self.loadData.bind(self), 120000);
                    },
                    error: function (json) {
                        console.log(json);
                    }
                })
            },
            ready: function () {
                this.loadData();
            },
            changeDirection: function(event, detail) {
                this.currentDirection = detail.item.attributes['data-direction'].value;
            },
            closeLine: function() {
                document.querySelector('bus-detail-line').style.display = 'none';
            }

        });
    </script>

</polymer-element>